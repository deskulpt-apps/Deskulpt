//! Tauri commands.
#![doc = include_str!("../permissions/autogenerated/reference.md")]

use deskulpt_common::SerResult;
use deskulpt_registry::{Index, WidgetPreview, WidgetReference};
use tauri::{AppHandle, Runtime};

use crate::WidgetsExt;
use crate::model::Widgets;
use crate::settings::WidgetSettingsPatch;

#[tauri::command]
#[specta::specta]
pub(crate) async fn read<R: Runtime>(app_handle: AppHandle<R>) -> SerResult<Widgets> {
    let widgets = app_handle.widgets().read().clone();
    Ok(widgets)
}

#[tauri::command]
#[specta::specta]
pub(crate) async fn update_settings<R: Runtime>(
    app_handle: AppHandle<R>,
    id: String,
    patch: WidgetSettingsPatch,
) -> SerResult<()> {
    app_handle.widgets().update_settings(&id, patch)?;
    Ok(())
}

#[tauri::command]
#[specta::specta]
pub(crate) async fn refresh<R: Runtime>(app_handle: AppHandle<R>, id: String) -> SerResult<()> {
    app_handle.widgets().refresh(&id)?;
    Ok(())
}

#[tauri::command]
#[specta::specta]
pub(crate) async fn refresh_all<R: Runtime>(app_handle: AppHandle<R>) -> SerResult<()> {
    app_handle.widgets().refresh_all()?;
    Ok(())
}

#[tauri::command]
#[specta::specta]
pub async fn fetch_registry_index<R: Runtime>(app_handle: AppHandle<R>) -> SerResult<Index> {
    let index = app_handle.widgets().fetch_registry_index().await?;
    Ok(index)
}

#[tauri::command]
#[specta::specta]
pub async fn preview<R: Runtime>(
    app_handle: AppHandle<R>,
    widget: WidgetReference,
) -> SerResult<WidgetPreview> {
    let preview = app_handle.widgets().preview(&widget).await?;
    Ok(preview)
}

#[tauri::command]
#[specta::specta]
pub async fn install<R: Runtime>(
    app_handle: AppHandle<R>,
    widget: WidgetReference,
) -> SerResult<()> {
    app_handle.widgets().install(&widget).await?;
    Ok(())
}

#[tauri::command]
#[specta::specta]
pub async fn uninstall<R: Runtime>(
    app_handle: AppHandle<R>,
    widget: WidgetReference,
) -> SerResult<()> {
    app_handle.widgets().uninstall(&widget).await?;
    Ok(())
}

#[tauri::command]
#[specta::specta]
pub async fn upgrade<R: Runtime>(
    app_handle: AppHandle<R>,
    widget: WidgetReference,
) -> SerResult<()> {
    app_handle.widgets().upgrade(&widget).await?;
    Ok(())
}
