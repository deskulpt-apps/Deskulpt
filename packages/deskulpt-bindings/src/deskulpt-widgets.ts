/*! Auto-generated by xtask-gen. DO NOT EDIT! */

import { invoke } from "@tauri-apps/api/core";
import * as tauriEvent from "@tauri-apps/api/event";

// =============================================================================
// Types
// =============================================================================

/**
 * The widget catalog.
 * 
 * This is a collection of all widgets discovered locally, mapped from their
 * widget IDs to their configurations. Invalid widgets are also included with
 * their error messages.
 */
export type Catalog = { [key in string]: Outcome<WidgetConfig> }

/**
 * Deskulpt window enum.
 */
export type DeskulptWindow = 
/**
 * The manager window.
 */
"manager" | 
/**
 * The canvas window.
 */
"canvas"

/**
 * A result-like binary outcome.
 * 
 * This represents the outcome of an operation that can either succeed with a
 * value of type `T` or fail with an error message.
 */
export type Outcome<T> = { type: "ok"; content: T } | { type: "err"; content: string }

/**
 * Event for rendering a widget.
 * 
 * This event is emitted from the backend to the canvas window to instruct it
 * to render the specified widget.
 */
export type RenderEvent = { 
/**
 * The ID of the widget.
 */
id: string; 
/**
 * Either the code string to render or a bundling error message.
 */
code: Outcome<string> }

/**
 * Event for updating the widget catalog.
 * 
 * This event is emitted from the backend to all frontend windows whenever
 * there is a change in the widget catalog.
 */
export type UpdateEvent = Catalog

/**
 * Full configuration of a Deskulpt widget.
 */
export type WidgetConfig = { 
/**
 * The name of the widget.
 */
name: string; 
/**
 * The entry point of the widget.
 */
entry: string; 
/**
 * The dependencies of the widget.
 */
dependencies: { [key in string]: string } }

// =============================================================================
// Events
// =============================================================================

function makeEvent<T>(name: string) {
  return {
    /** The name of the event. */
    name,
    /** Listen for the event. */
    listen: (cb: tauriEvent.EventCallback<T>, options?: tauriEvent.Options) =>
      tauriEvent.listen(name, cb, options),
    /** Listen once for the event. */
    once: (cb: tauriEvent.EventCallback<T>, options?: tauriEvent.Options) =>
      tauriEvent.once(name, cb, options),
    /** Emit the event to all targets. */
    emit: (payload: T) => tauriEvent.emit(name, payload),
    /** Emit the event to a specific Deskulpt window. */
    emitTo: (window: DeskulptWindow, payload: T) =>
      tauriEvent.emitTo(window, name, payload),
  };
}

export const events = {
  render: makeEvent<RenderEvent>("deskulpt-widgets://render"),
  update: makeEvent<UpdateEvent>("deskulpt-widgets://update"),
};

// =============================================================================
// Commands
// =============================================================================

export const commands = {
  /**
   * Bundle widget(s).
   * 
   * This command bundles the specified widget(s) that exist in the catalog. If
   * `id` is not provided, all widgets in the catalog are bundled. This only
   * notifies the bundler to process the widgets and does not wait for the
   * bundling to complete. Bundling results are communicated back to the canvas
   * window asynchronously.
   * 
   * ### Errors
   * 
   * - Error sending any bundling task to the bundler.
   */
  bundle: (
    id: string | null,
  ) => invoke<null>("plugin:deskulpt-widgets|bundle", {
    id,
  }),

  /**
   * Rescan the widgets directory to discover widgets.
   * 
   * This command scans the widgets directory for available widgets and updates
   * the widget catalog and settings accordingly. It then emits events to notify
   * the frontend of these changes. Finally, it triggers the bundling of all
   * widgets in the updated catalog with `bundle_widgets` to ensure they are
   * ready for use.
   * 
   * ### Errors
   * 
   * - Error reloading all widgets.
   * - Error rendering all widgets.
   */
  rescan: () => invoke<null>("plugin:deskulpt-widgets|rescan"),

  /**
   * Mark the window to have completed its setup.
   * 
   * If all setup has been completed after marking this window as completed, this
   * command will automatically trigger an initial rescan of the widgets.
   * 
   * ### Errors
   * 
   * - Error rescanning the widgets (if applicable).
   */
  completeSetup: () => invoke<null>("plugin:deskulpt-widgets|complete_setup"),
};
